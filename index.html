<!DOCTYPE html>
<html>
 <head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.0.3/css/bootstrap.min.css">
  <style>
    .department {
      opacity: 0.85;
      stroke-width: 0.5;
      stroke: rgb(10,10,10);
    }
    .department:hover {
      opacity: 1;
      stroke-width: 1.5;
    }
  </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="row">
        <label><input type="radio" name="mode" value="2007_12h">2007 à 12h</label>
        <label><input type="radio" name="mode" value="2007_17h">2007 à 17h</label>
        <label><input type="radio" name="mode" value="2012_12h">2012 à 12h</label>
        <label><input type="radio" name="mode" value="2012_17h" checked>2012 à 17h</label>
        <label><input type="radio" name="mode" value="2014_12h">2014 à 12h</label>
      </div>
      </div>
      <div id="map"></div>
      <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
      <script src="./js/francedom.js"></script>
      <script src="http://d3js.org/topojson.v1.min.js"></script>
      <script type="text/javascript">
        var valueAttr = '2012_17h'
        var colorScales = {};
        var participationData = {};
        var color = d3.scale.linear()
          .domain([0, 50, 100])
          .range(["#4575b4", "#ffffbf", "#a50026"])
          .interpolate(d3.interpolateHcl);
        var tooltip = d3.select(document.createElement('div'))
          .append("div")
          .attr("class", "popover")
          .style("display", 'none');
        var format = d3.format("0,000");
        document.body.appendChild(tooltip.node());
        var width = 1000, height = 550;
        var path = d3.geo.path();
        var projection = d3.geo.conicConformal() // Lambert-93
                .center([2.454071, 47.279229])
                .scale(3000)
                .translate([width / 2, height / 2]);
        var projection = d3.geo.franceDom().showPolynesie(false);
        path.projection(projection);

        var svg = d3.select("#map").append("svg")
          .attr("width", width)
          .attr("height", height);

          d3.json('./data/france.topojson', function(error, departments) {
              d3.dsv(";", "text/plain")("./data/participation_history.csv", function(error, data) {
                // Make something with dat
                data.forEach(function(row) {
                  if (participationData[row.code_dep]!=null) {
                    participationData[row.code_dep][row.nom] = +row.taux_participation;
                  } else {
                    participationData[row.code_dep] = {}
                  }
                });

                // Add departments
                var features = topojson.feature(departments, departments.objects.departments).features;
                var map =svg.selectAll(".department")
                  .data(features)
                  .enter().append("path")
                  .attr('class', 'department')
                  .attr("fill", function(d) { return color(participationData[d.properties.code][valueAttr]); })
                  .on("mouseover", function(d, i) {
                    var text = "<div class='popover-content'> <b>" +
                    d.properties.name + ' (' + d.properties.code + ')' +
                      " : " + participationData[d.properties.code][valueAttr] + " %";
                      "</b></div>";
                    tooltip.html(text);
                    tooltip.style("left", d3.event.pageX + 10 + "px");
                    tooltip.style("top", d3.event.pageY - 50 + "px");
                    tooltip.style("display", "block")
                  })
                  .on("mouseout", function() {
                    tooltip.style("display", "none");
                  })
                  .attr("d", path);

              d3.selectAll("input").on("change", function change() {
                valueAttr = this.value;
                map.data(features)
                  .transition()
                  .duration(1500)
                  .attr("fill", function(d) { console.log(d); return color(participationData[d.properties.code][valueAttr]); });
              });
            });
          });
      </script>
    </div>
  </body>
</html>
